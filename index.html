<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Addict's Agenda</title>
    <!-- Load React and Babel via CDN to run JSX directly -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional custom styles for smoother rendering */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        #root { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        /* Preserve line breaks for journal/workbook text */
        .whitespace-pre-wrap { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        // Paste the entire contents of your App.jsx below this line.

        // --- Literature Data ---
        // (Data remains the same but is now inside the <script type="text/babel"> tag)
        const literatureData = {
            aa_big_book: {
                title: "The Big Book (Alcoholics Anonymous)",
                pdfLink: "https://www.aa.org/sites/default/files/2021-11/en_bigbook_personalstories_1st.pdf",
                chapters: [
                    { title: "The Doctor's Opinion", content: `WE of Alcoholics Anonymous believe that the reader will be interested in the medical estimate of the plan of recovery described in this book. Convinced medical men...` },
                    { title: "Chapter 1: Bill's Story", content: `WAR FEVER ran high in the New England town to which we new, young officers from Plattsburg were assigned, and we were flattered...` },
                    { title: "Chapter 5: How It Works", content: `RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program...` },
                ]
            },
            na_basic_text: {
                title: "The Basic Text (Narcotics Anonymous)",
                pdfLink: "https://www.na.org/admin/include/spaw2/uploads/pdf/litfiles/us_english/Book/Sixth%20Edition%20Basic%20Text.pdf",
                chapters: [
                    { title: "Who is an Addict?", content: `Most of us do not have to think twice about this question. We know! Our whole life and thinking was centered in drugs in one form or another...` },
                    { title: "What is the Narcotics Anonymous Program?", content: `N.A. is a nonprofit fellowship or society of men and women for whom drugs had become a major problem. We are recovering addicts who meet regularly to help each other stay clean...` },
                ]
            }
        };

        // --- SVG Icons (Simplified for HTML compatibility) ---
        const BookOpenIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
        const TargetIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
        const LifeBuoyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line><line x1="9.17" y1="14.83" x2="4.93" y2="19.07"></line></svg>;
        const ClipboardListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>;
        const ShieldIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;
        const ArrowLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3L9.27 9.27L3 12l6.27 2.73L12 21l2.73-6.27L21 12l-6.27-2.73z"/></svg>;
        const CheckCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const LibraryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v2H6.5A2.5 2.5 0 0 1 4 16.5v-11A2.5 2.5 0 0 1 6.5 3H20v14H6.5A2.5 2.5 0 0 1 4 14.5Z"/><path d="m2 7 2 5 2-5"/><path d="m8.5 7.5 4 4-4 4"/></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;


        // --- LOCAL STORAGE UTILITIES (Unchanged) ---
        const LocalDataStore = {
            KEYS: { SOBRIETY: 'recovery_sobriety_date', JOURNAL: 'recovery_journal_entries', GOALS: 'recovery_goals', WORKBOOK: 'recovery_workbook_responses' },
            load: (key) => {
                try {
                    const serializedData = localStorage.getItem(key);
                    return serializedData === null ? (key === LocalDataStore.KEYS.SOBRIETY ? null : []) : JSON.parse(serializedData);
                } catch (error) {
                    console.error(`Error loading data from localStorage for key ${key}:`, error);
                    return key === LocalDataStore.KEYS.SOBRIETY ? null : [];
                }
            },
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving data to localStorage for key ${key}:`, error);
                }
            },
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        };

        // --- HOOK: useAuth (Simplified) ---
        const useAuth = () => {
            const user = React.useMemo(() => ({ uid: 'local_user_id' }), []);
            return { user, isAuthLoading: false };
        };

        // --- COMPONENT: Spinner ---
        const Spinner = ({ small = false }) => ( <div className={`flex justify-center items-center ${small ? '' : 'h-full'}`}><div className={`animate-spin rounded-full border-t-2 border-b-2 border-teal-500 ${small ? 'h-6 w-6' : 'h-16 w-16'}`}></div></div>);

        // --- COMPONENT: SobrietyDataSetup ---
        const SobrietyDataSetup = ({ onDateSet }) => {
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const handleSave = () => {
                const newStartDate = new Date(date);
                LocalDataStore.save(LocalDataStore.KEYS.SOBRIETY, newStartDate.toISOString());
                onDateSet(newStartDate);
            };
            return ( <div className="flex flex-col items-center justify-center h-full p-6 bg-gray-50 rounded-xl shadow-lg animate-fade-in"><h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome</h2><p className="text-gray-600 mb-6 text-center">Let's start your journey. Please select your sobriety start date.</p><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500" /><button onClick={handleSave} className="mt-6 bg-teal-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-teal-700 transition-transform transform hover:scale-105">Begin Journey</button></div> );
        };

        // --- COMPONENT: SobrietyTracker ---
        const SobrietyTracker = ({ startDate }) => {
            const calculateTimeSober = React.useCallback(() => {
                const diff = new Date().getTime() - new Date(startDate).getTime();
                return { days: Math.floor(diff / 86400000), hours: Math.floor((diff % 86400000) / 3600000), minutes: Math.floor((diff % 3600000) / 60000), seconds: Math.floor((diff % 60000) / 1000) };
            }, [startDate]);
            const [timeSober, setTimeSober] = React.useState(calculateTimeSober());
            React.useEffect(() => { const timer = setInterval(() => setTimeSober(calculateTimeSober()), 1000); return () => clearInterval(timer); }, [calculateTimeSober]);
            const timeUnits = [ { label: 'Days', value: timeSober.days }, { label: 'Hours', value: timeSober.hours }, { label: 'Minutes', value: timeSober.minutes }, { label: 'Seconds', value: timeSober.seconds } ];
            return ( <div className="bg-white p-6 rounded-xl shadow-lg text-center"><h3 className="text-lg font-semibold text-gray-500 mb-4">You are on your path</h3><div className="grid grid-cols-4 gap-2 sm:gap-4">{timeUnits.map(unit => ( <div key={unit.label} className="flex flex-col items-center bg-gray-100 p-2 sm:p-3 rounded-lg"><span className="text-3xl sm:text-4xl font-bold text-teal-600">{String(unit.value).padStart(2, '0')}</span><span className="text-xs sm:text-sm text-gray-600 uppercase tracking-wider">{unit.label}</span></div> ))}</div></div> );
        };

        // --- COMPONENT: Dashboard ---
        const Dashboard = ({ onNavigate, sobrietyStartDate }) => {
            const menuItems = [
                { view: 'journal', label: 'Daily Journal', icon: <BookOpenIcon /> },
                { view: 'goals', label: 'My Goals', icon: <TargetIcon /> },
                { view: 'coping', label: 'Coping Cards', icon: <ShieldIcon /> },
                { view: 'workbook', label: 'Recovery Workbook', icon: <ClipboardListIcon /> },
                { view: 'literature', label: 'Recovery Literature', icon: <LibraryIcon /> },
                { view: 'resources', label: 'S.O.S. Resources', icon: <LifeBuoyIcon /> },
            ];
            return ( <div className="animate-fade-in space-y-6"><SobrietyTracker startDate={sobrietyStartDate} /><div className="grid grid-cols-1 sm:grid-cols-2 gap-4">{menuItems.map(item => ( <button key={item.view} onClick={() => onNavigate(item.view)} className="flex items-center p-6 bg-white rounded-xl shadow-lg hover:shadow-xl hover:bg-teal-50 transition-all transform hover:-translate-y-1"><div className="text-teal-500 mr-4">{item.icon}</div><span className="text-lg font-semibold text-gray-700">{item.label}</span></button> ))}</div></div> );
        };

        // --- COMPONENT: GeminiJournalHelper ---
        // (Functionality relies on external API call and remains largely the same)
        const GeminiJournalHelper = ({ onInsertText, onClose }) => {
            const [prompt, setPrompt] = React.useState(''); const [isLoading, setIsLoading] = React.useState(false); const [result, setResult] = React.useState(''); const [error, setError] = React.useState('');
            const handleGenerate = async () => {
                if (!prompt.trim()) { setError('Please enter a topic or feeling.'); return; }
                setIsLoading(true); setResult(''); setError('');
                const systemPrompt = "You are a gentle and supportive journaling assistant for someone in recovery... Start the entry naturally, without greetings like 'Dear Journal'.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const data = await response.json(); const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) setResult(text); else throw new Error("No text returned.");
                } catch (e) { console.error("Gemini API call failed:", e); setError("Sorry, I couldn't generate a response right now."); } finally { setIsLoading(false); }
            };
            return ( <div className="p-4 border-t-2 border-teal-100 mt-4 space-y-3"><p className="text-sm text-gray-600 font-semibold">Need help starting? Give the AI a topic.</p><textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="e.g., 'Feeling grateful' or 'Anxious about work'..." className="w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2"/><button onClick={handleGenerate} disabled={isLoading} className="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 disabled:bg-gray-400 flex items-center justify-center">{isLoading ? <Spinner small /> : 'Generate Idea'}</button>{error && <p className="text-red-500 text-sm">{error}</p>}{result && ( <div className="p-3 bg-gray-100 rounded-lg space-y-3"> <p className="text-gray-800 text-sm">{result}</p> <button onClick={() => { onInsertText(result); onClose(); }} className="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Use This Entry</button> </div> )}</div> );
        };

        // --- GENERIC MODULES (Journal, Goals) ---
        const createListModule = (config) => {
            const storageKey = config.collectionName === 'journal' ? LocalDataStore.KEYS.JOURNAL : LocalDataStore.KEYS.GOALS;

            return ({ journalTemplate, setJournalTemplate }) => {
                const isJournal = config.collectionName === 'journal';
                const [items, setItems] = React.useState([]);
                const [newItem, setNewItem] = React.useState('');
                const [editingItem, setEditingItem] = React.useState(null);
                const [editedText, setEditedText] = React.useState('');
                const [isLoading, setIsLoading] = React.useState(true);
                const [showGeminiHelper, setShowGeminiHelper] = React.useState(false);

                // Load data on initial render
                React.useEffect(() => {
                    const loadedItems = LocalDataStore.load(storageKey);
                    const formattedItems = loadedItems.map(item => ({
                        ...item,
                        timestamp: item.timestamp ? new Date(item.timestamp) : new Date(0)
                    })).sort((a, b) => (b.timestamp.getTime()) - (a.timestamp.getTime()));

                    setItems(formattedItems);
                    setIsLoading(false);
                }, [storageKey]);
                
                // Handle template injection from Coping Cards
                React.useEffect(() => {
                    if (journalTemplate && setJournalTemplate) {
                        setNewItem(journalTemplate);
                        setJournalTemplate('');
                    }
                }, [journalTemplate, setJournalTemplate]);

                // Persistence handler
                const saveItemsToLocal = (updatedItems) => {
                    const sortAndSet = updatedItems.sort((a, b) => (b.timestamp.getTime()) - (a.timestamp.getTime()));
                    setItems(sortAndSet);
                    const serializableItems = sortAndSet.map(item => ({
                        ...item,
                        timestamp: item.timestamp.toISOString()
                    }));
                    LocalDataStore.save(storageKey, serializableItems);
                };

                // CRUD Handlers
                const handleAddItem = (e) => {
                    e.preventDefault();
                    if (newItem.trim() === '') return;
                    const newItemObject = { 
                        id: LocalDataStore.generateId(), 
                        text: newItem, 
                        timestamp: new Date()
                    };
                    if (config.hasCompleted) newItemObject.completed = false;
                    
                    saveItemsToLocal([newItemObject, ...items]);
                    setNewItem('');
                };

                const handleToggleCompleted = (item) => {
                    if (!config.hasCompleted) return;
                    const updatedItems = items.map(i => 
                        i.id === item.id ? { ...i, completed: !i.completed } : i
                    );
                    saveItemsToLocal(updatedItems);
                };

                const handleDeleteItem = (id) => {
                    const updatedItems = items.filter(item => item.id !== id);
                    saveItemsToLocal(updatedItems);
                };

                const handleEdit = (item) => {
                    setEditingItem(item);
                    setEditedText(item.text);
                };

                const handleUpdateItem = (e) => {
                    e.preventDefault();
                    if (!editingItem || editedText.trim() === '') return;

                    const updatedItems = items.map(item => 
                        item.id === editingItem.id ? { ...item, text: editedText, timestamp: new Date() } : item
                    );
                    
                    saveItemsToLocal(updatedItems);
                    setEditingItem(null);
                    setEditedText('');
                };

                const NewEntryForm = () => (
                    <form onSubmit={handleAddItem} className="
