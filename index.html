<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Addict's Agenda</title>
    <!-- Load React, ReactDOM, and Babel (to process JSX/modern JS) via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- IMPORTANT: Babel must load before your JSX script -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define custom font and ensure full-screen layout */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        #root { display: flex; justify-content: center; min-height: 100vh; width: 100%; }
        /* Preserve line breaks for journal/workbook text */
        .whitespace-pre-wrap { white-space: pre-wrap; }
        /* Style for the Step Quote */
        .step-quote {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #10b981;
            background-color: #f0fdfa;
            color: #064e3b;
            font-style: italic;
            border-radius: 0.25rem;
        }
        .workbook-question {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-recovery': {
                            100: '#e6fffa',
                            500: '#38b2ac',
                            600: '#319e9a',
                        },
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Your JSX code must be inside a script tag with type="text/babel" -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- APPLICATION VERSIONING ---
        // NOTE: These versions must be manually incremented whenever logic for that specific component changes.
        const APP_VERSIONS = {
            DASHBOARD: '1.0.1',
            JOURNAL: '1.4.0', // Updated to functional
            GOALS: '1.1.0', // Updated to functional
            COPING: '1.1.0',
            WORKBOOK: '1.4.0',
            LITERATURE: '1.1.0',
            RESOURCES: '1.0.0',
        };

        // --- Literature Data (Truncated for brevity, full content is in your source) ---
        const literatureData = {
            aa_big_book: {
                title: "The Big Book (Alcoholics Anonymous)",
                pdfLink: "https://www.aa.org/sites/default/files/2021-11/en_bigbook_personalstories_1st.pdf",
                chapters: [
                    { title: "The Doctor's Opinion", content: `WE of Alcoholics Anonymous believe that the reader will be interested in the medical estimate of the plan of recovery described in this book. Convinced medical men...` },
                    { title: "Chapter 1: Bill's Story", content: `WAR FEVER ran high in the New England town to which we new, young officers from Plattsburg were assigned, and we were flattered...` },
                    { title: "Chapter 5: How It Works", content: `RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program...` },
                ]
            },
            na_basic_text: {
                title: "The Basic Text (Narcotics Anonymous)",
                pdfLink: "https://www.na.org/admin/include/spaw2/uploads/pdf/litfiles/us_english/Book/Sixth%20Edition%20Basic%20Text.pdf",
                chapters: [
                    { title: "Who is an Addict?", content: `Most of us do not have to think twice about this question. We know! Our whole life and thinking was centered in drugs in one form or another...` },
                    { title: "What is the Narcotics Anonymous Program?", content: `N.A. is a nonprofit fellowship or society of men and women for whom drugs had become a major problem. We are recovering addicts who meet regularly to help each other stay clean...` },
                ]
            }
        };

        // --- SVG Icons (Lucide Icons) ---
        const BookOpenIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
        const TargetIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
        const LifeBuoyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line><line x1="9.17" y1="14.83" x2="4.93" y2="19.07"></line></svg>;
        const ClipboardListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>;
        const ShieldIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;
        const ArrowLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3L9.27 9.27L3 12l6.27 2.73L12 21l2.73-6.27L21 12l-6.27-2.73z"/></svg>;
        const CheckCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const LibraryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v2H6.5A2.5 2.5 0 0 1 4 16.5v-11A2.5 2.5 0 0 1 6.5 3H20v14H6.5A2.5 2.5 0 0 1 4 14.5Z"/><path d="m2 7 2 5 2-5"/><path d="m8.5 7.5 4 4-4 4"/></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>;
        const CheckIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;


        // --- UTILITY HOOKS ---
        
        // Custom hook for debouncing a callback (useful for performance, though not strictly required for local storage)
        const useDebouncedCallback = (callback, delay) => {
            const timeoutRef = useRef(null);
            return useCallback((...args) => {
                if (timeoutRef.current) { clearTimeout(timeoutRef.current); }
                timeoutRef.current = setTimeout(() => { callback(...args); }, delay);
            }, [callback, delay]);
        };


        // --- LOCAL STORAGE UTILITIES ---
        const LocalDataStore = {
            KEYS: { SOBRIETY: 'recovery_sobriety_date', JOURNAL: 'recovery_journal_entries', GOALS: 'recovery_goals', WORKBOOK: 'recovery_workbook_responses' },
            load: (key) => {
                try {
                    const serializedData = localStorage.getItem(key);
                    const parsedData = serializedData === null ? (key === LocalDataStore.KEYS.SOBRIETY ? null : []) : JSON.parse(serializedData);

                    // Hydrate timestamp/date fields back to Date objects if necessary
                    if (Array.isArray(parsedData)) {
                        return parsedData.map(item => ({
                            ...item,
                            timestamp: new Date(item.timestamp),
                            // Goals specific: ensure 'completed' is boolean
                            completed: typeof item.completed === 'boolean' ? item.completed : false 
                        }));
                    }
                    return parsedData;

                } catch (error) {
                    console.error(`Error loading data from localStorage for key ${key}:`, error);
                    return key === LocalDataStore.KEYS.SOBRIETY ? null : [];
                }
            },
            save: (key, data) => {
                try {
                    // Prepare data for serialization (convert Date objects to ISO strings)
                    let serializableData = data;
                    if (Array.isArray(data)) {
                         serializableData = data.map(item => ({
                            ...item,
                            timestamp: item.timestamp.toISOString()
                        }));
                    }
                    
                    localStorage.setItem(key, JSON.stringify(serializableData));
                } catch (error) {
                    console.error(`Error saving data to localStorage for key ${key}:`, error);
                }
            },
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        };

        // --- HOOK: useAuth (Simplified) ---
        const useAuth = () => {
            const user = useMemo(() => ({ uid: 'local_user_id' }), []);
            return { user, isAuthLoading: false };
        };

        // --- COMPONENT: Spinner ---
        const Spinner = ({ small = false }) => ( <div className={`flex justify-center items-center ${small ? '' : 'h-full'}`}><div className={`animate-spin rounded-full border-t-2 border-b-2 border-teal-500 ${small ? 'h-6 w-6' : 'h-16 w-16'}`}></div></div>);

        // --- COMPONENT: SobrietyDataSetup ---
        const SobrietyDataSetup = ({ onDateSet }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const handleSave = () => {
                const newStartDate = new Date(date);
                LocalDataStore.save(LocalDataStore.KEYS.SOBRIETY, newStartDate.toISOString());
                onDateSet(newStartDate);
            };
            return ( <div className="flex flex-col items-center justify-center h-full p-6 bg-gray-50 rounded-xl shadow-lg animate-fade-in"><h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome</h2><p className="text-gray-600 mb-6 text-center">Let's start your journey. Please select your sobriety start date.</p><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500" /><button onClick={handleSave} className="mt-6 bg-teal-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-teal-700 transition-transform transform hover:scale-105">Begin Journey</button></div> );
        };

        // --- COMPONENT: SobrietyTracker ---
        const SobrietyTracker = ({ startDate }) => {
            const calculateTimeSober = () => {
                const diff = new Date().getTime() - new Date(startDate).getTime();
                // Ensure diff is not negative (should not happen if date is set correctly, but good for safety)
                if (diff < 0) return { days: 0, hours: 0, minutes: 0, seconds: 0 };
                
                return { days: Math.floor(diff / 86400000), hours: Math.floor((diff % 86400000) / 3600000), minutes: Math.floor((diff % 3600000) / 60000), seconds: Math.floor((diff % 60000) / 1000) };
            };
            const [timeSober, setTimeSober] = useState(calculateTimeSober());
            useEffect(() => { const timer = setInterval(() => setTimeSober(calculateTimeSober()), 1000); return () => clearInterval(timer); }, [startDate]);
            const timeUnits = [ { label: 'Days', value: timeSober.days }, { label: 'Hours', value: timeSober.hours }, { label: 'Minutes', value: timeSober.minutes }, { label: 'Seconds', value: timeSober.seconds } ];
            return ( <div className="bg-white p-6 rounded-xl shadow-lg text-center"><h3 className="text-lg font-semibold text-gray-500 mb-4">You are on your path</h3><div className="grid grid-cols-4 gap-2 sm:gap-4">{timeUnits.map(unit => ( <div key={unit.label} className="flex flex-col items-center bg-gray-100 p-2 sm:p-3 rounded-lg"><span className="text-3xl sm:text-4xl font-bold text-teal-600">{String(unit.value).padStart(2, '0')}</span><span className="text-xs sm:text-sm text-gray-600 uppercase tracking-wider">{unit.label}</span></div> ))}</div></div> );
        };

        // --- COMPONENT: Dashboard ---
        const Dashboard = ({ onNavigate, sobrietyStartDate }) => {
            const menuItems = [
                { view: 'journal', label: 'Daily Journal', icon: <BookOpenIcon /> },
                { view: 'goals', label: 'My Goals', icon: <TargetIcon /> },
                { view: 'coping', label: 'Coping Cards', icon: <ShieldIcon /> },
                { view: 'workbook', label: 'Recovery Workbook', icon: <ClipboardListIcon /> },
                { view: 'literature', label: 'Recovery Literature', icon: <LibraryIcon /> },
                { view: 'resources', label: 'S.O.S. Resources', icon: <LifeBuoyIcon /> },
            ];
            return ( <div className="animate-fade-in space-y-6 max-w-lg mx-auto w-full"><SobrietyTracker startDate={sobrietyStartDate} /><div className="grid grid-cols-1 sm:grid-cols-2 gap-4">{menuItems.map(item => ( <button key={item.view} onClick={() => onNavigate(item.view)} className="flex items-center p-6 bg-white rounded-xl shadow-lg hover:shadow-xl hover:bg-teal-50 transition-all transform hover:-translate-y-1"><div className="text-teal-600 mr-4">{item.icon}</div><span className="text-lg font-semibold text-gray-700">{item.label}</span></button> ))}</div></div> );
        };
        
        // --- Journal Templates Data ---
        const journalTemplates = [
            { id: '', name: 'Select a Template...' },
            { id: 'gratitude', name: '3-Part Gratitude Check', template: 'Today I am grateful for:\n1. (Person/Relationship)\n2. (Experience/Event)\n3. (Small Detail)\n\nHow did this feeling of gratitude influence my day?' },
            { id: 'halt', name: 'The H.A.L.T. Check', template: 'Before reacting or craving, I will check:\n\n**H**ungry? (Yes/No): \n**A**ngry? (Yes/No): \n**L**onely? (Yes/No): \n**T**ired? (Yes/No): \n\nWhat action did I take to meet my true need?' },
            { id: 'resentment', name: 'Resentment Filter', template: 'Today I felt resentful toward: (Person/Situation)\n\nWhat did they do? \n\nWhat part of my self-esteem (pride, security, ambition) did this threaten? \n\nWhat is my part in this situation?' },
            { id: 'step_10', name: 'Step 10 Spot Check', template: 'Where was I wrong today? (Small admissions of fault or mistake)\n\nWas I mindful of others?\n\nDid I practice honesty in a difficult situation?\n\nIf I was wrong, did I promptly admit it?' },
        ];


        // --- COMPONENT: GeminiJournalHelper ---
        const GeminiJournalHelper = ({ onInsertText, onClose }) => {
            const [prompt, setPrompt] = useState(''); const [isLoading, setIsLoading] = useState(false); const [result, setResult] = useState(''); const [error, setError] = useState('');
            const handleGenerate = async () => {
                if (!prompt.trim()) { setError('Please enter a topic or feeling.'); return; }
                setIsLoading(true); setResult(''); setError('');
                const systemPrompt = "You are a gentle and supportive journaling assistant for someone in recovery. Provide a brief, reflective paragraph (under 80 words) to help them start writing about the topic they provided. Start the entry naturally, without greetings like 'Dear Journal'.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const data = await response.json(); 
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) setResult(text); else throw new Error("No text returned.");
                } catch (e) { 
                    console.error("Gemini API call failed:", e); 
                    setError("Sorry, I couldn't generate a response right now. Please try again or write on your own!"); 
                } finally { 
                    setIsLoading(